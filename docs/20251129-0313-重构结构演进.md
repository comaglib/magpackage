这是一个非常关键的复盘。通过对比 **MagPackage v1.0**（原始代码）和 **MagPackage v3.0**（现在的重构版本），我们可以清晰地看到架构的演进以及**尚未迁移或特意废弃的功能**。

虽然 v3.0 在架构、并行效率、非线性收敛性和场路耦合的严谨性上远超 v1.0，但以下功能目前**尚未包含在 v3.0 中**：



### 1. 标量场求解能力 (Scalar Potential Solver)



- **v1.0 功能**：包含 `assemble_scalar_laplacian.m`。
- **v3.0 现状**：**缺失**。
- **影响**：目前 v3.0 只能求解矢量场（$\mathbf{A}$ 场）。无法求解：
  - **直流电流传导问题**（Current Conduction）：求解 $\nabla \cdot (\sigma \nabla V) = 0$ 以获得电流密度分布。
  - **静电场问题**（Electrostatics）：求解 $\nabla \cdot (\epsilon \nabla V) = \rho$。
- **建议**：如果需要计算导电体内的电流分布（作为源导入磁场），需要补充一个 `ScalarSolver`。



### 2. 独立的电路参数提取工具 (Parameter Extraction)



- **v1.0 功能**：包含 `extract_circuit_parameters.m`，用于后处理计算电感矩阵、电阻矩阵等。
- **v3.0 现状**：**缺失**。
- **影响**：虽然 v3.0 可以进行场路耦合仿真（直接仿真电路行为），但缺乏一个专门的工具来“扫描”多绕组系统，自动输出 $L_{ij}$（自感与互感矩阵）及 $R$ 参数，这在建立降阶模型时很有用。



### 3. Tree-Cotree 规范条件 (Gauging Strategy)



- **v1.0 功能**：包含 `apply_gauge_strategy.m`，支持 Tree-Cotree 方法。
- **v3.0 现状**：**改用正则化**。
- **影响**：v3.0 采用了 **质量矩阵正则化 ($K + \varepsilon M$)** 来处理旋度算子的零空间问题。这种方法不仅并行效率高，而且对线性求解器更友好。Tree-Cotree 方法虽然数学上精确（完全消除零空间），但在并行化和非结构网格预处理上极其复杂且耗时。
- **结论**：这是一个**架构选择**，正则化通常是现代商业软件（如 COMSOL/Ansys）的首选。



### 4. 解析线圈源 (Analytical Biot-Savart Sources)



- **v1.0 功能**：`src/sources/` 下包含大量 Biot-Savart 积分代码，支持跑道形、圆角矩形线圈的解析磁场计算。
- **v3.0 现状**：**已废弃**。
- **影响**：v3.0 强制使用有限元源项（`CurrentSource` / `Winding`），即电流必须在网格上定义。这意味着用户不能在不画网格的情况下随意放置线圈。
- **优势**：废弃它是为了统一物理框架，消除了 $O(N^2)$ 的稠密矩阵计算，极大地提升了组装速度。



### 5. 高阶单元支持 (Higher Order Elements)



- **v1.0 功能**：依托 `symbolic_engine`，理论上支持生成高阶基函数。
- **v3.0 现状**：**仅支持一阶单元 (P1)**。
- **影响**：v3.0 的内核（`nedelec_tet_p1`）是硬编码优化的。如果需要二阶单元（Tet10 / Edge2），需要重新编写对应的 Shape Function 和 Kernel。



### 6. 符号计算引擎接口 (Symbolic Engine Integration)



- **v1.0 功能**：包含 `derive_kernels.m`，可以直接从数学公式生成 MATLAB 代码。
- **v3.0 现状**：**内核已固定**。
- **影响**：v3.0 的内核是手动优化过的（为了并行性能）。如果需要修改物理方程（例如引入磁滞回线模型或多物理场），不能直接通过修改符号脚本自动生成新内核，需要手动编写 `assemble_xxx_kernel`。

------



### 总结与建议



**MagPackage v3.0** 现在是一个**专注于高性能、非线性、场路耦合磁场仿真**的求解器。它在核心能力上已经超越了 1.0，但在“通用性”和“辅助工具”上做了一些减法。

**如果您希望继续完善 v3.0，建议的优先级如下：**

1. **[高] 补充 `ScalarSolver`**：这是最缺的功能，用于计算电流场（Current Flow），为磁场分析提供真实的电流密度分布源。
2. **[中] 参数提取工具**：封装一个 `ParameterExtractor` 类，自动计算多端口阻抗/电感矩阵。
3. **[低] 高阶单元**：只有在精度要求极高时才需要，工作量较大。

您想先执行哪一项？或者我们先结束本次重构工作？