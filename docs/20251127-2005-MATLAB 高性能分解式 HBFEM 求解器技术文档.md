

# MATLAB 高性能分解式 HBFEM 求解器技术文档

版本：2.0 (High-Performance Smart Adaptive)

文件：solve_hbfem_decomposed.m

适用领域：三维低频非线性磁场仿真（变压器、电抗器、电机等深度饱和工况）

------

[toc]

## 1. 概述 (Overview)

本求解器采用了 **分解式谐波平衡有限元法 (Decomposed Harmonic Balance FEM)**，专为解决强非线性、深度饱和的电磁场问题而设计。

不同于传统的全耦合 HBFEM（求解巨大的 Block-Toeplitz 矩阵），本求解器利用不动点迭代策略（Fixed-Point Iteration），将谐波间的耦合项移至方程右端作为“等效磁化电流”处理。这使得系统矩阵解耦为多个独立的单频小矩阵，极大地降低了内存消耗，并实现了完美的并行化。

本版本进一步集成了 **智能步进 (Smart Ramping)**、**源场平滑 (Source Smoothing)** 和 **动态松弛 (Dynamic Relaxation)** 技术，解决了传统分解法在深度饱和区不收敛的难题。

------

## 2. 核心数学模型 (Mathematical Formulation)

### 2.1 控制方程

求解器基于磁矢位 $\mathbf{A}$ 的 $\mathbf{A}-V$ 表述。对于反应场（Reaction Field）求解策略，总磁场分解为：

$$\mathbf{B}_{tot} = \mathbf{B}_s + \mathbf{B}_r$$

其中 $\mathbf{B}_s$ 为线圈产生的源场（Biot-Savart），$\mathbf{B}_r = \nabla \times \mathbf{A}_r$ 为铁磁材料产生的反应场。

### 2.2 定点迭代方程

为了处理非线性 $\mathbf{H} = \nu(\mathbf{B}) \mathbf{B}$，我们引入一个线性参考磁阻率 $\nu_{DC}$（通常取空气或直流分量），将方程重写为：

$$\nabla \times (\nu_{DC} \nabla \times \mathbf{A}_r) + j\omega\sigma \mathbf{A}_r = -\nabla \times \mathbf{M}_{resid} - \nabla \times (\nu \mathbf{B}_s)$$

右端项包含两部分驱动力：

1. **非线性残差 (M-Residual)**: $\mathbf{M}_{resid} = (\nu(t) - \nu_{DC}) \mathbf{B}_{tot}(t)$
   - 该项修正了线性矩阵 $\nu_{DC}$ 与真实物理属性 $\nu(t)$ 之间的差异。
2. **源场驱动 (Source Drive)**: $\mathbf{M}_{src} = \nu(t) \mathbf{B}_s(t)$
   - 该项代表外部源场对铁磁材料的磁化驱动作用。

------

## 3. 关键特性与算法创新 (Key Features)

### 3.1 智能自适应负载步进 (Smart Adaptive Ramping)

- **机制**：求解器不会立即施加 100% 的电流，而是从 0% 开始逐步增加负载。
- **智能调节**：
  - 如果在当前负载步收敛极快（<5次迭代），系统会自动**倍增**下一步的负载增量（例如直接从 20% 跳到 40%）。
  - 如果收敛困难，系统会维持或减小步长。
- **优势**：在线性区极速推进，在非线性区精细计算，兼顾速度与稳定性。

### 3.2 几何内核预计算 (Geometry Pre-computation)

- **机制**：在迭代循环开始前，利用 `prepare_static_data` 函数预先计算所有单元的 `Curl(N)` 矩阵和体积积分因子。
- **优势**：在数以百计的迭代步中，避免了重复计算雅可比矩阵和形函数导数，使得右端项（RHS）组装速度提升 **5-10倍**。

### 3.3 源场自适应平滑 (Adaptive Source Smoothing)

- **问题**：传统 Biot-Savart 模型在网格节点靠近导线时会产生 $1/r$ 奇点，导致局部磁场高达数百特斯拉，引发数值发散。

- 解决方案：引入 Soft-Clip 平滑技术。

  $$\mathbf{B}_{safe} = \mathbf{B}_{raw} \cdot \frac{B_{limit}}{\sqrt{|\mathbf{B}_{raw}|^2 + B_{limit}^2}}$$

  其中 $B_{limit}$ 根据物理极限（如 10T）设定。

- **效果**：消除了非物理的数学奇点，确保了深度饱和区的计算稳定性。

### 3.4 动态松弛控制 (Dynamic PID Relaxation)

- **机制**：监控残差的变化率。
  - **误差下降时**：松弛因子 $\alpha$ 缓慢增加（最大 1.0），加速收敛。
  - **误差震荡时**：松弛因子 $\alpha$ 迅速减小（最小 0.05），通过强阻尼消除震荡。
- **M-Scaling**：在 $B > 3.0T$ 的极端饱和区，额外对残差向量 $\mathbf{M}$ 进行幅度缩放，防止正反馈死锁。

### 3.5 MUMPS 求解器优先

- 代码内置检测机制，如果检测到 `linear_solve` (MUMPS 接口)，则优先使用 MUMPS 直接求解器处理稀疏矩阵，显著优于 MATLAB 内置求解器。

------

## 4. 函数接口说明 (Interface)

### 调用格式

```Matlab
[Solution, Info] = solve_hbfem_decomposed(Model, Coil, HBFEMParams)
```

### 输入参数 (Inputs)

| **参数名**          | **类型** | **描述**                                |
| ------------------- | -------- | --------------------------------------- |
| **Model**           | struct   | 有限元模型核心结构体                    |
| `.Mesh`             | struct   | 网格数据 (`.P`, `.T`, `.T2E` 等)        |
| `.Materials`        | struct   | 材料库与属性映射 (`.Lib`, `.ActiveMap`) |
| **Coil**            | struct   | 线圈定义                                |
| `.HarmonicCurrents` | vector   | 各次谐波的电流幅值 [I1, I3, I5...]      |
| `.Turns`            | double   | 线圈匝数                                |
| **HBFEMParams**     | struct   | 求解控制参数                            |
| `.Frequency`        | double   | 基波频率 (Hz)                           |
| `.Harmonics`        | vector   | 待求解谐波次数列表 (如 `[1, 3, 5]`)     |
| `.TimeSteps`        | int      | (可选) 时域采样点数，建议留空以自动优化 |

### 输出参数 (Outputs)

| **参数名**    | **类型** | **描述**                                  |
| ------------- | -------- | ----------------------------------------- |
| **Solution**  | struct   | 求解结果                                  |
| `.Harmonics`  | matrix   | 磁矢位谐波系数矩阵 `[NumEdges x NumHarm]` |
| **Info**      | struct   | 统计信息                                  |
| `.Iterations` | int      | 总迭代步数                                |
| `.TimeSteps`  | int      | 实际使用的时域采样点数                    |

------

## 5. 内部流程图 (Algorithm Workflow)

1. **初始化 (Initialization)**
   - 自动计算最佳 $N_{time}$ (Power of 2)。
   - 并行池启动。
   - **Vacuum Start**: 初始化 $\nu_{DC} = \nu_0$ (全空气)，确保初始矩阵正定且“硬”。
2. **预计算 (Pre-computation)**
   - 计算所有单元的 `Curl_N` 和 `Volume`。
   - 计算 Biot-Savart 源场 $\mathbf{B}_s$，并应用平滑处理。
3. **主迭代循环 (Main Loop)**
   - **Step A: 负载步进 (Ramping)**
     - 根据收敛历史调整 `load_scale`。
   - **Step B: 矩阵组装 (Assembly)**
     - 组装 $K_{base}(\nu_{DC})$。
   - **Step C: 属性更新 (Update & Residual)**
     - (并行) 将 $A$ 转为时域 $B(t)$。
     - (并行) 查表更新 $\nu(B)$。
     - (并行) 计算残差 $\mathbf{M}_{resid}$ 和源驱动 $\mathbf{M}_{src}$。
   - **Step D: 线性求解 (Solve)**
     - 对每个谐波 $k$，组装 RHS = Eddy - Resid - Source。
     - 调用 MUMPS 求解 $K x = RHS$。
   - **Step E: 收敛检查 (Check)**
     - 计算误差，更新 $\alpha$，判断是否进入下一负载步。

------

## 6. 使用建议 (Best Practices)

1. **材料定义**：确保 B-H 曲线覆盖了深度饱和区（例如延伸至 2.5T 或更高），否则样条插值可能在超出范围时产生非物理振荡。
2. **网格质量**：虽然算法有源场平滑，但为了获得最佳精度，建议在线圈导线截面附近进行网格加密。
3. **调试**：如果求解器在 `Load=10%` 处停滞，通常意味着初始步长过大或 B-H 曲线在低场区斜率过高，无需干预，自适应算法会自动减速处理。