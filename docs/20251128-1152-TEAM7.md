这是一套非常完整的有限元求解框架。基于你提供的代码结构，特别是 `solve_frequency_linear.m`（线性频域求解器）和 `create_racetrack_coil.m`（跑道线圈生成），你已经具备了求解 TEAM Problem 7（非对称导体板涡流基准问题）的所有核心组件。

TEAM 7 是一个经典的 **3D 线性时谐涡流损耗** 问题。以下是利用你的 `magpackage` 实施该案例的详细步骤分解和代码实现。

------



### 第一步：理解 TEAM 7 物理模型



1. **几何结构**：
   - 一个铝板（导体），尺寸通常为 $294 \times 294 \times 19$ mm，中心有一个偏置的孔。
   - 一个跑道型线圈，放置在铝板上方，与铝板不对称。
2. **物理参数**：
   - 铝板电导率：$\sigma \approx 3.526 \times 10^7$ S/m。
   - 相对磁导率：$\mu_r = 1$ (线性)。
   - 激励电流：安匝数（例如 2742 AT），频率通常为 50Hz, 200Hz。
3. **目标**：
   - 计算铝板上的涡流分布 ($J$)。
   - 计算特定路径上的磁感应强度 ($B_z$)。

------



### 第二步：网格生成 (`create_team7_mesh.m`)



你需要编写一个新的网格生成脚本。由于你的包使用了基于 Delaunay 的点云生成法 (`create_delaunay_mesh_robust`)，我们需要修改它来适应带有孔的板。



### 第三步：主求解脚本 (`run_team7.m`)



编写主脚本来调用求解器。这里使用的是你的 `solve_frequency_linear`，因为 TEAM 7 是线性频域问题。



### 第四步：需要注意的关键点



在使用你的代码包进行 TEAM 7 测试时，有几个关键技术细节需要注意，这些在你提供的文件中已经有所体现，但需要组合正确：

1. A-V 公式的完备性：

   你的 solve_frequency_linear.m 实现了 A-V 公式。

   - **矩阵**：$K + j\omega \sigma M + \epsilon M_{reg}$。
   - **右端项**：`b_ind = -1i * omega * (M_sigma * As_vec)`。
   - **非常重要**：确保铝板区域的 `IsConductive` 被正确识别，否则涡流项 $j\omega \sigma A$ 为零，结果将变成静磁场。检查 `assemble_mass_matrix` 中的 `ConductorOnly` 模式是否正确读取了 Tag=2 的电导率。

2. 源场计算 (Biot-Savart)：

   TEAM 7 的线圈是空气芯。你的求解器采用 $A_r$ (Reduced A) 方法，即 $A_{total} = A_s + A_r$。

   - 方程左边求解的是 $A_r$。
   - 右端项由源场驱动。在 `solve_frequency_linear` 中，你使用了 `project_source_A_on_edges` 产生的 `As_unit` 来构建感应电动势驱动项 ($j\omega \sigma A_s$)。这是完全正确的做法。

3. 结果合成：

   在后处理计算 $B$ 时，必须计算 $B_{total} = \nabla \times A_r + B_s$。

   - $A_r$ 是 FEM 解出来的。
   - $B_s$ 必须通过 `compute_biot_savart_B` 重新计算并叠加。如果只画 FEM 结果，会丢失源场部分。我在上面的 `analyze_results` 中已经包含了这一步。

4. MUMPS 求解器设置：

   TEAM 7 是开域问题，空气包越大越好，但这会导致矩阵很大。你的代码集成了 MUMPS 并开启了自动缩放 (ICNTL(8)=77)，这对于处理空气(低电导率)和导体(高电导率)混合的病态矩阵至关重要。



### 总结实施路线



1. **准备几何**：基于 `create_delaunay_mesh_robust.m` 修改出一个 `create_team7_mesh`，生成带孔铝板和空气包的 `.msh` 文件。
2. **配置物理**：在主脚本中设定 Aluminium 的 $\sigma$ 和 Coil 的几何/电流。
3. **运行求解**：直接调用 `solve_frequency_linear`。
4. **验证**：提取测量线上的 B 场，记得 **叠加 Biot-Savart 源场**。

你的代码库已经包含了所有必要的“乐高积木”，只需要按照上述逻辑拼装即可完成基准测试。



----



好的，我们按照分解步骤执行。

**第一步：生成 TEAM 7 基准几何网格（内存直取模式）**

为了满足“不从文件读取”和“内存直取”的要求，我们需要编写一个脚本直接在 MATLAB 内存中生成点云、进行 Delaunay 剖分、修正网格手性（确保体积为正），并构建符合求解器要求的拓扑结构。



### 1. 代码实现：`create_team7_mesh_direct.m`



请将以下代码保存为 `create_team7_mesh_direct.m`。

**代码逻辑说明：**

1. **几何定义**：定义了 $294 \times 294 \times 19$ mm 的铝板和一个 $108 \times 108$ mm 的偏心孔。
2. **点云生成**：分别生成“背景空气”、“铝板加密区”和“孔加密区”的点云，合并后去重。
3. **拓扑构建**：使用 `delaunayTriangulation` 生成四面体。
4. **手性修正**：复用了 中的核心逻辑，检查混合积并翻转节点顺序，防止负体积导致的求解崩溃。
5. **材料标记**：通过计算单元重心（Centroid），判断单元是在“铝板实体”内还是“空气/孔”内，分别赋予 `Tag=2` (导体) 和 `Tag=1` (空气)。
6. **边界提取**：使用 `freeBoundary` 自动计算外表面，用于后续施加边界条件。



---



好的，执行**第二步：物理参数配置与模型初始化**。

这一步的核心是将纯几何网格（Mesh）转化为具有物理意义的有限元模型（Model）。我们将定义材料属性（铝板的电导率）、激励源（跑道线圈）以及边界条件，并最终构建出完整的 `Model` 结构体。



### 2. 代码实现：`step2_setup_physics.m`



请将以下代码保存为 `step2_setup_physics.m` 并运行。

**代码逻辑说明：**

1. **加载环境**：自动运行 `startup_fem` 确保路径正确。
2. **获取网格**：调用第一步编写的 `create_team7_mesh_direct` 获取网格数据。
3. **构建拓扑**：调用 `build_topology` 生成棱边（Edges）和邻接关系，这是 FEM 求解的基础。
4. **材料指派**：
   - **Tag 1 (Air)**: 绝缘体，$\mu_r=1$。
   - **Tag 2 (Aluminum)**: 导体，$\sigma = 3.526 \times 10^7$ S/m（TEAM 7 标准值），$\mu_r=1$。
5. **线圈建模**：
   - 生成跑道型线圈的几何数据。
   - **位置关键点**：TEAM 7 的线圈底部通常距离铝板上表面一定高度。这里设定为 $z=19+15=34$ mm 中心高度（示例值），确保线圈悬浮在板上方且与板不对称。
6. **边界条件**：识别最外层空气边界（Tag 100），用于后续施加磁矢位 $A=0$ 的狄利克雷边界条件。



### 验证结果



请检查输出日志，关注以下几点以确认本步骤成功：

1. **材料映射**：确认 `Active V-DoF`（导电节点数）**不为 0**。如果为 0，说明铝板区域的 Material Tag 没有正确对应到含 `Sigma` 的材料，这将导致涡流无法计算。
2. **边界条件**：确认 `Identified ... fixed edges` 的数量**大于 0**。
3. **几何关系**：你可以简单画图验证线圈和网格的相对位置：



----



好的，执行 **第三步：频域求解与结果验证**。

这一步我们将编写主求解脚本 `run_team7.m`。该脚本将调用之前生成的物理模型，使用 `solve_frequency_linear` 求解器进行计算，并执行后处理以提取和验证磁场分布。



### 3. 代码实现：`run_team7.m`



请将以下代码保存为 `run_team7.m` 并运行。

**代码逻辑说明：**

1. **模型加载**：自动检查工作区是否存在 `Model` 和 `Coil`（来自第二步），如果不存在则自动调用 `step2_setup_physics` 重新生成。
2. **求解配置**：
   - 频率设定为 50 Hz（TEAM 7 标准测试频率之一）。
   - 调用线性频域求解器 `solve_frequency_linear`。
3. **后处理 (关键步骤)**：
   - 定义测量线：沿 Y 轴，位于铝板上方 $Z=30$mm 处（即距离板表面 11mm，这也正好穿过线圈底部附近）。
   - **场合成**：计算总磁场 $B_{total} = B_{source} + B_{eddy}$。
     - $B_{source}$：通过 Biot-Savart 定律直接由线圈电流计算。
     - $B_{eddy}$：通过 FEM 求解得到的磁矢位 $A$ 计算 ($\nabla \times A$)。
   - 绘制 $B_z$ 分量的分布曲线。



### 预期结果



运行后，你应当看到：

1. 控制台输出求解进度和时间。
2. 弹出一个图形窗口，显示 $B_z$ 沿 Y 轴的分布。
   - **黑色虚线**：纯线圈产生的磁场（无铝板时）。
   - **蓝色实线**：总磁场（线圈 + 铝板涡流）。
   - **物理现象**：由于涡流的去磁效应（Lenz 定律），在铝板正上方的区域，**总磁场（蓝色）应该低于源磁场（黑色）**。如果你观察到这一现象，说明涡流求解是物理正确的。

这样我们就完成了 TEAM 7 基准案例的全流程测试。



------



好的，感谢您提供官方文档。通过仔细阅读 `problem7.pdf`，我提取到了确切的几何尺寸参数，并发现之前的代码在**线圈形状**和**坐标系**上存在偏差。

**纠正方案总结：**

1. **线圈形状**：TEAM 7 的线圈不是跑道形（两直边两圆弧），而是**圆角正方形**（四直边四圆角）。
2. **线圈尺寸**：
   - 内孔尺寸：$150 \times 150$ mm。
   - 内圆角半径：$R_{in}=25$ mm。
   - 外圆角半径：$R_{out}=50$ mm。
   - 由此推导线圈厚度为 25mm，**平均丝状线圈**的直线段位置在 $\pm 87.5$ mm，圆角半径 $R_{mean}=37.5$ mm。
   - 线圈 Z 轴位置：底部距离板 30mm，线圈高 100mm -> 中心 Z = 19 + 30 + 50 = 99 mm。
3. **板与孔的坐标**：
   - 板尺寸：$294 \times 294 \times 19$ mm。
   - 孔尺寸：$108 \times 108$ mm。
   - 位置：基于 Fig 1(a)，若以板中心为原点 $(0,0)$，孔是偏心的。
   - 原点变换：文档坐标系原点在板左下角。板中心在 $(147, 147)$。
   - 孔范围（原坐标）：$X \in [18, 126]$，$Y \in [18, 126]$。
   - **新坐标系（板中心）**：孔范围 $X,Y \in [-129, -21]$ mm。



----



分析结果如下：

1. **Curve 1 ($B_z$) 严重偏低**：
   - **现象**：FEM 计算出的 $B_z$（红色实线）在 $\pm 10$ Gauss 左右，而参考值（黑色方块）高达 75 Gauss。
   - **原因**：这通常意味着**源场 ($B_{source}$) 计算错误**。在 $t=0$ 时刻，总磁场主要由线圈的源场主导。现在的数值仅为理论值的 1/10 甚至反向，说明线圈的安匝数可能未正确传递，或者线圈几何生成的方向/位置有误，导致 Biot-Savart 积分结果极其微弱。
2. **Curve 2 & 3 ($J_y$) 剧烈震荡**：
   - **现象**：在导体与空气的交界面（x=126mm 附近）及内部，电流密度出现了高达 $9 \times 10^6$ 的非物理尖峰，且正负跳变。
   - **原因**：这是典型的**悬浮电位（Floating Potential）**问题。在 $A-V$ 表述中，对于孤立导体，标量电势 $V$ 的解不唯一（差一个常数），导致刚度矩阵中的 $G$ 块奇异。求解器得出的 $V$ 是巨大的随机噪声，进而导致 $J = -\sigma (j\omega A + \nabla V)$ 出现巨大震荡。

------



### 解决方案



我们需要执行以下三个修正步骤：

1. **修正网格 (Mesh)**：增加 Z 方向的层数，以更好地捕捉趋肤效应。
2. **修正求解器 (Solver)**：在 `solve_frequency_linear` 中引入**参考地 (Reference Ground)**，强制固定导体上某一点的 $V=0$，消除矩阵奇异性。
3. **修正后处理 (Post-Processing)**：在 `run_team7` 中增加源场自检，确保输入求解器的 $B_s$ 是正确的。



---



这是一个非常有价值的反馈。您指出的两个问题非常准确：

1. **Run_team7 代码错误**：`Unrecognized field name "Info"` 是因为我在上一轮的修复中，虽然让 `solve_frequency_linear` 返回了 `Info`，但在 `run_team7` 的后处理函数 `compare_results_full` 中没有正确传递它。
2. **线圈建模合理性质疑**：您关于 `create_thick_rounded_rectangle_coil` 的质疑在 FEM 领域非常经典。
   - **关于积分点**：确实，既然网格（Mesh）本身就是一种空间离散，直接利用网格单元的高斯积分点（Gauss Quadrature Points）来定义电流密度 $\mathbf{J}$ 是最自然的“全耦合”做法。
   - **为什么代码用“丝”？**：目前的算法采用的是 **$A-\phi$ (Reduced Potential)** 表述。这种方法将磁矢势分解为 $A = A_r + A_s$。其中源场 $A_s$ 通常由 **Biot-Savart 定律** 解析计算。为了计算 $A_s$，我们需要一个独立的源模型（线圈几何）。如果直接用不规则的网格单元进行 Biot-Savart 积分，在计算量和近场奇异性处理上往往不如规则的“解析积分丝（Filaments）”高效。
   - **如何确定丝数？**：这里的“丝”实际上不仅仅是物理导线，更是**截面数值积分点**。5x5 意味着我们在截面上使用了 25 阶的高斯积分。通常通过收敛性测试确定：增加积分点数量直到磁场结果不再变化。对于 TEAM 7 这种近场问题（测量线 A1-B1 离线圈很近），需要较多的积分点（如 4x4 或 5x5）才能消除源场的“波纹”。









