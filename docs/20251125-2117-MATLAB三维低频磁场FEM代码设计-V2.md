好的，我根据你的新要求更新了设计方案。新的设计在保持高性能计算（并行化、SoA架构）的基础上，大幅增强了系统的**模块化**、**灵活性**和**物理功能的完备性**。

特别针对你提到的**符号数学工具箱（Symbolic Math Toolbox）**的使用，这是一个非常现代且高效的策略，前提是必须采用“代码生成（Code Generation）”模式，而非“在线计算”模式。

以下是更新后的MATLAB三维低频磁场有限元代码包详细设计报告。

------

# 模块化全并行MATLAB三维磁场有限元代码包设计（v2.0）

[toc]

## 1. 总体架构设计：模块化与扩展性

为了满足后期独立增减功能的需求，代码架构采用“微内核+插件式”的设计理念。主程序仅负责调度，具体的物理计算、矩阵组装、材料更新等均封装为独立且无状态（Stateless）的函数模块。

### 1.1 核心数据总线（Model Data Bus）

摒弃复杂的类继承体系，使用一个标准化的 `Model` 结构体作为数据总线，在各模块间传递。

```Matlab
Model
  ├── Mesh          % 网格数据（P, T, Edges等）
  ├── Physics       % 物理场配置（区域标记、源定义、边界条件）
  ├── Materials     % 材料属性库（含非线性曲线、JA参数、损耗系数）
  ├── Solver        % 求解器配置（步长、公差、非线性方法选择）
  └── Runtime       % 运行时数据（当前场解、历史变量、损耗累积）
```

### 1.2 模块化流程图

每个矩形框代表一个独立的 `.m` 文件或文件夹，模块之间低耦合。

1. **I/O模块**：`MeshReader` (Gmsh/Ansys) -> `ResultWriter` (VTK/Matlab)
2. **预计算模块**：`SymbolicGenerator` (公式推导与代码生成) -> `TopologyBuilder`
3. **组装模块**：`Assembler_Stiffness` | `Assembler_Mass` | `Assembler_Source` | `Assembler_Gauge`
4. **求解控制**：`NonlinearSolver` (NR/Relax) -> `LinearSolver_Interface` (MUMPS)
5. **后处理**：`FieldCalculator` -> `LossEstimator` -> `CoilAnalyzer`

------

## 2. 物理场公式与区域离散策略

### 2.1 涡流区与非涡流区的分离（$\mathbf{A}-V$ Formulation）

为了减少自由度并提高条件数，采用分离式电势表述 [2]：

- 非导电区（空气/铁心） $\Omega_{nc}$：

  仅求解磁矢量位 $\mathbf{A}$。

  $$\nabla \times (\nu \nabla \times \mathbf{A}) = 0$$

- 导电区（线圈/实心导体） $\Omega_{c}$：

  求解 $\mathbf{A}$ 和 电标量位 $V$。

  $$ \nabla \times (\nu \nabla \times \mathbf{A}) + \sigma \frac{\partial \mathbf{A}}{\partial t} + \sigma \nabla V = 0 $$   $$ \nabla \cdot \left( \sigma \frac{\partial \mathbf{A}}{\partial t} + \sigma \nabla V \right) = 0 $$

**实现策略：**

- `DOF_Map` 模块负责生成自由度映射：$\mathbf{A}$ 定义在所有棱（Edge）上，$V$ 仅定义在 $\Omega_{c}$ 内的节点（Node）上。
- 这比全域求解 $V$ 节省了大量内存。

### 2.2 规范条件（Gauge Condition）的模块化实现

用户可选择两种方式处理 $\nabla \cdot \mathbf{A} = 0$，通过模块开关切换：

1. 罚函数法（Penalty Method）：

   在刚度矩阵中添加 $\alpha \int (\nabla \cdot \mathbf{A}) (\nabla \cdot \mathbf{v}) d\Omega$。

   - **优点：** 保持矩阵正定，不增加自由度。
   - **缺点：** 罚因子 $\alpha$ 的选取影响精度和条件数。

2. 拉格朗日乘子法（Lagrange Multiplier）：

   引入额外的标量场 $\lambda$（通常定义在节点上），强制约束 $\int \lambda (\nabla \cdot \mathbf{v}) = 0$。

   - **优点：** 精确满足规范，无需调试参数。
   - **缺点：** 产生鞍点问题（零对角块），矩阵不定。
   - **MUMPS支持：** MUMPS 求解器对不定矩阵（Indefinite Matrix）有很好的支持，因此推荐使用此方法作为高精度选项 1。

------

## 3. 符号工具箱驱动的单元内核生成（Feature 4）

这是提升代码可维护性和性能的关键。不要在 `parfor` 循环中调用符号计算，而是用它来**写代码**。

### 3.1 设计思路

1. **离线推导（Offline）**：编写一个脚本 `derive_element_matrix.m`，使用 `sym` 变量定义形函数（节点、棱）、雅可比变换、旋度运算、能量泛函。
2. **自动代码生成（Auto-Coding）：** 使用 `matlabFunction(..., 'File', 'ElementKernel_Auto.m')` 将符号表达式转换为高度优化的、无符号依赖的纯 MATLAB 函数。
3. **运行时调用：** 主程序直接调用生成的 `ElementKernel_Auto.m`。

### 3.2 性能评估

- **合理性：** 非常合理。`matlabFunction` 生成的代码会自动进行公共子表达式消除（CSE），其运行效率通常高于人工手写的代码，且完全支持向量化。
- **扩展性：** 当需要增加损耗项或改变材料模型时，只需修改符号表达式并重新生成文件，无需手动推导复杂的导数。

```Matlab
% 伪代码示例：生成单元刚度矩阵内核
syms x y z real % 参考坐标
% 定义棱单元基函数 N_edge (矢量)
% 定义雅可比矩阵 J
% 推导 Curl_N
K_local_sym = int(Curl_N' * nu * Curl_N * det(J),...); 
matlabFunction(K_local_sym, 'File', 'generated_kernels/calc_Ke_stiff.m',...
    'Vars', {nu, J_inv, det_J,...});
```

------

## 4. 材料非线性与损耗模块（Features 3, 5）

### 4.1 材料接口标准化

设计一个 `MaterialUpdate` 模块，输入 $\mathbf{B}$ 场，输出 $\nu$（磁阻率）和 $\frac{d\nu}{dB^2}$。

- **BH曲线：** 采用三次样条插值（`spline` 或 `pchip`），预先计算好导数表以加速查找。
- **Jiles-Atherton (JA) 模型：**
  - 需引入**历史变量（History Variables）**，即每个积分点需存储上一时间步的 magnetization $\mathbf{M}$ 和 anysteretic magnetization $\mathbf{M}_{an}$。
  - **并行化难点：** 历史变量的读写需与单元索引对齐，利用 MATLAB 的大数组按列存储特性（`GlobalHistory(:, ElementIndices)`）即可在 `parfor` 中高效访问。

### 4.2 损耗计算模块（后处理/在线）

损耗计算独立于求解器，作为后处理插件：

1. **欧姆损耗（Ohmic Loss）：** $\int_{\Omega_c} \frac{1}{\sigma} |\mathbf{J}|^2 d\Omega$。直接利用 $\mathbf{A}-V$ 解计算。
2. **磁滞损耗（Hysteresis Loss）：**
   - **时域：** $\int \mathbf{H} \cdot d\mathbf{B}$，在每个时间步累积闭合回线面积。
   - **频域（HBFEM）：** 基于 Steinmetz 公式或改进的频域损耗分离模型。
3. **涡流损耗（Eddy Loss in Laminations）：**
   - 对于叠片铁心，不直接剖分叠片，采用各向异性电导率或基于 Bertotti 的均匀化公式进行后处理估算。

------

## 5. 求解器体系：扩展性设计（Feature 6）

求解器被设计为“策略模式（Strategy Pattern）”的变体。

### 5.1 非线性迭代框架

```Matlab
function [x, conv] = NonlinearSolve(Method, ResidualFunc, JacobianFunc, x0)
    switch Method
        case 'NewtonRaphson'
            % 标准NR，需要计算雅可比
            [x, conv] = solve_NR(ResidualFunc, JacobianFunc, x0);
        case 'Relaxation'
            % 自适应松弛法，只需更新nu，不需要精确雅可比
            % 适合极其非线性或由于JA模型导致雅可比难以解析的情况
            [x, conv] = solve_FixedPoint(ResidualFunc, x0);
    end
end
```

- **Newton-Raphson (NR)**: 收敛快（二次收敛），但对初值敏感，且需计算切线刚度阵。
- **Relaxation (Fixed Point)**: 鲁棒性强，收敛慢。推荐结合线搜索（Line Search）或 Anderson 加速技术。

### 5.2 线性求解器接口

MUMPS 接口程序已就绪。建议封装为 `LinearSolver_Direct` 函数。若将来模型规模过大，可轻易扩展接入 `LinearSolver_Iterative` (如 GMRES + AMG 预条件子)。

------

## 6. 后处理与线圈分析（Feature 7）

### 6.1 场量计算

所有后处理计算均基于生成的形函数代码。

- $\mathbf{B} = \nabla \times \mathbf{A}$: 在积分点计算，然后通过 L2 投影（Mass Matrix Projection）平滑到节点上以便绘图。
- $\mathbf{J} = -\sigma (\frac{\partial \mathbf{A}}{\partial t} + \nabla V)$: 仅在导体区计算。

### 6.2 线圈参数提取

专门的 `CoilAnalyst` 模块：

- **磁链 $\Psi$**: $\Psi = \int_{coil} \mathbf{A} \cdot \mathbf{J}_{unit} d\Omega$。对于绞线线圈，利用对偶能量法计算更精确。
- **感应电压**: $U = -N \frac{d\Phi}{dt}$ 或直接从电路耦合方程中提取 $V$ 的差值。

------

## 7. 网格导入模块（Feature 8）

不重复造轮子，专注于**解析**。

- **Gmsh (.msh)**: 支持 ASCII 格式 2.2 和 4.1。编写高效的 `textscan` 解析器。
- **数据结构转换**：外部网格读入后，需立即通过 `TopologyBuilder` 转换为内部的 SoA 结构：
  - `Nodes` ($3 \times N_n$)
  - `Elements` ($4 \times N_e$)
  - `Edges` ($2 \times N_{edge}$): 这是一个计算密集型步骤，需利用 `sort` 和 `unique` 函数进行全向量化构建。

------

## 8. 未来优化：MEX与并行（Feature 9, 10）

### 8.1 MEX 预编译策略

目前的瓶颈在于 `parfor` 中大量的单元矩阵计算。虽然 `matlabFunction` 生成的代码很快，但将其编译为 C++ MEX 文件（使用 MATLAB Coder）可以进一步减少解释器开销。

- **计划：** 将 `ElementKernel_Auto.m` 编译为 `ElementKernel_Mex`。在 `parfor` 中直接调用 MEX 函数。

### 8.2 并行化细节

- **矩阵组装：** 坚持使用 Block-COO 格式（分块三元组），避免 `sparse` 函数在循环中动态分配。
- **损耗统计：** 利用 `parfor` 的 `Reduction` 变量（如 `TotalLoss = TotalLoss + local_loss`）自动并行累加。

------

## 9. 实施路线图（Step-by-Step）

1. **Stage 1: 基础架构与符号引擎**
   - 搭建 `Model` 数据结构。
   - 编写 `SymbolicGenerator`，生成四面体棱单元（Edge Element）的 curl-curl 矩阵代码。
   - 实现 `MeshReader` (Gmsh)。
2. **Stage 2: 线性静磁场求解**
   - 实现 `Assembler` (Stiffness, Source)。
   - 集成 MUMPS 接口。
   - 实现 `Penalty` 规范条件。
   - 验证跑道型线圈的解析源加载。
3. **Stage 3: 非线性与材料**
   - 实现 `MaterialUpdate` 模块（BH曲线）。
   - 编写 `NonlinearSolver` (NR框架)。
   - 验证饱和铁心案例。
4. **Stage 4: 涡流与瞬态**
   - 引入 `TimeStepper` (Backward Euler / Crank-Nicolson)。
   - 实现 $\mathbf{A}-V$ 导电区与 $\mathbf{A}$ 空气区的耦合矩阵。
   - 添加 `Lagrange Multiplier` 规范作为可选项。
5. **Stage 5: 损耗与高级功能**
   - 集成 JA 磁滞模型。
   - 编写 `LossEstimator`。
   - 实现 HBFEM 求解器（频域）。

这个设计方案完全符合您提出的所有新原则，特别是模块化和符号计算的应用，为构建一个高性能、科研级的电磁仿真工具奠定了坚实基础。