这是一份针对您构建的 MATLAB 三维低频磁场有限元代码包的完善说明文档。

本代码包已经实现了从底层拓扑构建到高阶非线性场路耦合求解的全流程并行化，具有极高的数值稳定性和工程实用价值。

------

# **MATLAB高性能三维低频磁场有限元 (FEM) 代码包说明文档**

## **I. 系统概览 (System Overview)**

本代码包旨在高效求解准静态麦克斯韦方程组，采用数据导向设计（Data-Oriented Design, DOD）和全并行化策略，以克服 MATLAB 解释执行的性能瓶颈。

### **核心特性**

| **特性**           | **描述**                                                     | **状态** |
| ------------------ | ------------------------------------------------------------ | -------- |
| **求解器架构**     | **Fixed-Point Iteration** (Picard) 替代敏感的牛顿迭代，实现非线性分析的极致鲁棒性。 | 已实现   |
| **场路耦合 (FCC)** | 支持电压源驱动的非线性瞬态场路耦合，电流 $I$ 作为求解域的未知数。 | 已实现   |
| **HPC 优化**       | 矩阵组装采用 **Map-Reduce 模式**，使用 `parfor` 和 `parallel.pool.Constant`，以及 **Row Scaling** 策略平衡场（$10^6$ 量级）与路（$10^{-1}$ 量级）的数值跨度。 | 已实现   |
| **网格 I/O**       | 兼容 Gmsh (`.msh`) 和 COMSOL (`.mphtxt`) 导出格式。          | 已实现   |
| **源场建模**       | 采用 **Biot-Savart 定律** 的无网格线圈模型。                 | 已实现   |

------

## **II. 核心数学模型与公式**

### **2.1 场变量与单元类型**

本系统采用混合自由度：

| **变量**     | **物理含义**      | **单元类型**                  | **自由度 (DoFs)**         |
| ------------ | ----------------- | ----------------------------- | ------------------------- |
| $\mathbf{A}$ | 磁矢量位 ($Wb/m$) | 棱单元 (Nédélec Edge Element) | 所有棱 (Edges)            |
| $V$          | 电标量位 ($V$)    | 节点单元 (Lagrange Node)      | 导电区节点 (Active Nodes) |
| $I$          | 线圈电流 ($A$)    | 全局自由度                    | 1 (每匝线圈)              |

### **2.2 耦合方程组 (Transient Nonlinear FCC)**

求解器基于后向欧拉（Backward Euler）和 Fixed-Point 迭代。系统在每个时间步的线性化矩阵 $\mathbf{J}$ 包含以下关键耦合块：

| **块**                                            | **物理含义**                                                | **组装函数**                             |
| ------------------------------------------------- | ----------------------------------------------------------- | ---------------------------------------- |
| $\mathbf{K}_{sec} + \frac{1}{\Delta t}\mathbf{M}$ | 磁场与惯性项 (Secant Stiffness)                             | `assemble_magnetic_stiffness`            |
| $\mathbf{C}$                                      | $\mathbf{A}$ 对 $V$ 的耦合 ($\sigma \nabla V$)              | `assemble_coupling_matrix`               |
| $\mathbf{Q}_{mag}$                                | $I$ 对 $\mathbf{A}$ 的源激励 ($\mathbf{F}_{coupling}$ 向量) | `assemble_rhs_reduced` (作为单位电流源)  |
| $\mathbf{W}^T / \Delta t$                         | 反电动势 (Back EMF) 耦合 ($\frac{d\Psi}{dt}$)               | `assemble_winding_vector`                |
| $R + \frac{L}{\Delta t}$                          | 电路阻抗 (Circuit Impedance)                                | `solve_transient_voltage_nonlinear` 内联 |

------

## **III. 求解器功能矩阵 (Solver Functionality Matrix)**

| **求解器名称**        | **物理特性**                               | **耦合模式**                             | **非线性处理**           | **核心函数**                          |
| --------------------- | ------------------------------------------ | ---------------------------------------- | ------------------------ | ------------------------------------- |
| **Static Linear**     | 稳态磁场                                   | 无                                       | 线性                     | `solve_linear_static.m`               |
| **Static Nonlinear**  | 稳态磁场                                   | 无                                       | Newton-Raphson (Tangent) | `solve_nonlinear_static.m`            |
| **Transient Eddy**    | 涡流 (Linear $\mu$)                        | $\mathbf{A}-V$ 强耦合                    | 线性                     | `solve_transient_linear.m`            |
| **Frequency Linear**  | 时谐场 ($\mathbf{K} + j\omega \mathbf{M}$) | $\mathbf{A}-V$ 强耦合                    | 线性                     | `solve_frequency_linear.m`            |
| **Transient Coupled** | 瞬态涡流                                   | $\mathbf{A}-V-I$ 强耦合 (Voltage Source) | Fixed-Point (Picard)     | `solve_transient_voltage_nonlinear.m` |

------

## **IV. 关键模块与文件说明**

| **文件名**                            | **模块/功能** | **关键算法**                             | **备注**                           |
| ------------------------------------- | ------------- | ---------------------------------------- | ---------------------------------- |
| `derive_kernels.m`                    | 符号引擎      | `matlabFunction` 代码生成                | 确保单元矩阵（Ke, Me, Ce）的高效性 |
| `read_mphtxt.m`                       | 网格 I/O      | `textscan` 自动分块，0-base $\to$ 1-base | 兼容 COMSOL 6.3 导出格式           |
| `build_topology.m`                    | 预处理        | T2E 映射与棱符号修正                     | 保证棱单元的正确性                 |
| `assemble_*.m`                        | 组装器        | **Map-Reduce** 模式，元素级并行          | 效率优化核心                       |
| `update_reluctivity_parallel.m`       | 材料更新      | 并行 B 场计算 $\to$ B-H 曲线样条查询     | 非线性迭代驱动                     |
| `solve_transient_voltage_nonlinear.m` | 核心求解器    | **Fixed-Point Iteration** + Row Scaling  | 求解最复杂的 $\mathbf{A}-V-I$ 系统 |
| `plot_mesh_domain.m`                  | 可视化        | 面去重 (Face Cancellation)               | 绘制清晰的域边界和外表面           |

------

## **V. 使用指南与验证 (Usage & Validation)**

### **5.1 环境设置**

1. 将代码包放置在同一根目录下。
2. 在 MATLAB 命令窗口运行 `startup_fem` (由 `build_distribution` 生成) 以设置路径。
3. 确保并行计算工具箱（Parallel Computing Toolbox）处于激活状态。

### **5.2 场路耦合测试 (Nonlinear Transient)**

此测试验证了系统在最恶劣工况下的稳定性：

1. **目标**：观察电流 $I(t)$ 随时间的变化，确认是否存在 **饱和加速现象** (Saturation Spike)。
2. **调用**：运行 `examples/test_nonlinear_transient.m`。
3. **结果判据**：
   - **电流**：必须从 $0$ 开始，平滑上升至 $V/R$（稳态值）。
   - **斜率**：$\text{Slope}_{late} / \text{Slope}_{early} > 1$。如果满足，则证明非线性饱和效应被正确捕捉。

### **5.3 网格验证**

- 运行 `plot_mesh_domain(Model.Mesh, [1, 2], struct('FaceAlpha', 0.5));` 可以绘制空气域 (Tag 1) 和铁心域 (Tag 2) 的外表面，验证网格导入和拓扑构建的正确性。
- 使用 `read_mphtxt('your_mesh.mphtxt', 'mm')` 可以导入 COMSOL 网格并自动转换为米。